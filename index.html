<meta charset="utf8">

<link rel="stylesheet" href="kite.min.css">

<style>
  .row, .sq {
    box-sizing: border-box;
    position: relative;
  }
  .cont {
    /*width: 512px;*/
  }
  .bg {
    box-sizing: content-box;
    border: solid 4px #666;
    border-left: none;
    position: relative;
    overflow: hidden;
  }
  .bg, .chs {
    -webkit-user-select: none;
    cursor: default;
  }
  /*.row {
    border-top: solid 2px #666;
  }
  .row:nth-child(1) {
    border-top: none;
  }*/
  .sq {
    width: 64px;
    height: 64px;
    display: inline-block;
    border-left: solid 4px #666;
    border-top: solid 4px #666;
    /*overflow: hidden;*/
  }
  .sq:nth-child(1) {
    /*border-left: none;*/
  }
  .row:nth-child(1) .sq {
    border-top: none;
  }
  .row.middle .sq {
    border-left: none;
  }
  .row.middle .sq:nth-child(1) {
    border-left: solid 4px #666;
  }
  .sq.cross:before {
    content: '';
    display: block;
    position: absolute;
    top: -2px;
    left: -90px;
    width: 181.01933598375618px;
    height: 181.01933598375618px;
    box-sizing: border-box;
    border-top: solid 4px #666;
    transform: rotate(45deg);
    transform-origin: top center;
  }
  .sq.cross:after {
    content: '';
    display: block;
    position: absolute;
    top: -2px;
    left: -93px;
    width: 181.01933598375618px;
    height: 181.01933598375618px;
    box-sizing: border-box;
    border-top: solid 4px #666;
    transform: rotate(-45deg);
    transform-origin: top center;
  }
  .mk {
    position: absolute;
    width: 16px;
    height: 16px;
    margin-left: -8px;
    margin-top: -8px;
    box-shadow: 0 0 0 4px #666;
  }
  .chs {
    z-index: 1;
    position: absolute;
  }
  .ch {
    position: absolute;
    width: 52px;
    height: 52px;
    border-radius: 52px;
    line-height: 52px;
    text-align: center;
    font-size: 32px;
    margin-left: -26px;
    margin-top: -26px;
    vertical-align: middle;
    background: wheat;
    text-shadow: 0 0 1px;
    box-shadow: 0 0 1px 1px rgba(0,0,0,.3);
  }
  .ch.green {
    color: green;
    cursor: pointer;
  }
  .ch.red {
    color: red;
  }
  .ch.active {
    outline: dashed 2px orange;
  }
</style>

<div class="kite kite--position">
  <div class="kite__item cont">
    <div class="chs"></div>
    <div class="bg"></div>
  </div>
</div>


<script>
  /// 绘制棋盘
  var bg = document.querySelector('.bg')
  var sqs = []
  for (var y = 0; y < 9; y++) {
    var row = document.createElement('div')
    row.classList.add('row')
    sqs[y] = row
    for (var x = 0; x < 8; x++) {
      var sq = document.createElement('div')
      sq.classList.add('sq')
      sqs[y][x] = sq
      row.appendChild(sq)
    }
    bg.appendChild(row)
  }

  var rows = document.querySelectorAll('.row')
  rows[4].classList.add('middle')

  sqs[1][4].classList.add('cross')
  sqs[8][4].classList.add('cross')

  var mks = [
    [2, 1], [2, 7],
    [3, 0], [3, 2], [3, 4], [3, 6], [3, 8],
    [6, 0], [6, 2], [6, 4], [6, 6], [6, 8],
    [7, 1], [7, 7]
  ]
  for (var i = 0; i < mks.length; i++) {
    var mk = document.createElement('div')
    mk.classList.add('mk')
    mk.style.top = (mks[i][0] * 64+2) + 'px'
    mk.style.left = (mks[i][1] * 64 +2) + 'px'
    bg.appendChild(mk)
  }

  /// 绘制棋子
  var chs = document.querySelector('.chs')
  var chsArr = [
    [1, '車', 0, 0], [1, '車', 0, 8],
    [1, '马', 0, 1], [1, '马', 0, 7],
    [1, '相', 0, 2], [1, '相', 0, 6],
    [1, '仕', 0, 3], [1, '仕', 0, 5],
    [1, '帅', 0, 4],
    [1, '砲', 2, 1], [1, '砲', 2, 7],
    [1, '兵', 3, 0], [1, '兵', 3, 2], [1, '兵', 3, 4], [1, '兵', 3, 6], [1, '兵', 3, 8],

    [0, '車', 9, 0], [0, '車', 9, 8],
    [0, '马', 9, 1], [0, '马', 9, 7],
    [0, '象', 9, 2], [0, '象', 9, 6],
    [0, '士', 9, 3], [0, '士', 9, 5],
    [0, '将', 9, 4],
    [0, '炮', 7, 1], [0, '炮', 7, 7],
    [0, '卒', 6, 0], [0, '卒', 6, 2], [0, '卒', 6, 4], [0, '卒', 6, 6], [0, '卒', 6, 8]
  ]
  for (var i = 0; i < chsArr.length; i++) {
    placeChess.apply(null, chsArr[i].concat(i))
  }

  function placeChess(side, name, y, x, i){
    var ch = document.createElement('span')
    ch.textContent = name
    ch.classList.add('ch', side ? 'red': 'green')
    ch.setAttribute('i', i)
    ch.style.top = en(y) + 'px'
    ch.style.left = en(x) + 'px'
    chs.appendChild(ch)
  }
  function en(n){
    return n * 64 + 2
  }
  function de(v){
    return (v - 2) / 64
  }

  /// 玩家走棋
  var side = null
  var done = null
  var pick = null
  var each = Array.prototype.forEach
  document.addEventListener('mousedown', function(e){
    e = e.originalEvent || e
    if (side === 0) {
      if (e.target.classList.contains('ch') &&
        e.target.classList.contains('green')) {
        each.call(chs.querySelectorAll('.ch'), function(ch){
          ch.classList.remove('active')
        })
        e.target.classList.add('active')
        pick = +e.target.getAttribute('i')
        return
      }
      if (pick) {
        var x = de(e.pageX - bg.offsetLeft)
        var y = de(e.pageY - bg.offsetTop)
        if (!(x >= 0 && x <=8 &&
          y >= 0 && y <= 9)) return
        if (Math.abs(Math.round(x) - x) > 0.3 ||
          Math.abs(Math.round(y) - y) > 0.3) return
        var ch = chs.querySelector(`[i="${pick}"]`)
        ch.style.left = en(Math.round(x))
        ch.style.top = en(Math.round(y))
        done = pick
        pick = null
        nextTurn()
        return
      }
    }
  })

  nextTurn()

  function nextTurn(){
    if (side == null) side = 1
    else side = side ? 0 : 1
    if (side === 1) {
      // todo: AI
      nextTurn()
    } else {

      
    }
  }
</script>